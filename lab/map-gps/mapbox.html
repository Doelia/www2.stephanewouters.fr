<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mapbox</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; }
        #map { height: 100%; width: 100%; }
        .picture { max-width: 220px; max-height: 300px; }
        /*.popup { width: 300px; }*/
    </style>


    <script src='https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css' rel='stylesheet' />
    <script
            src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>

</head>
<body>

<div id="map"></div>

<script>
    const p1 = [43.7524, 3.9077, 43.7754, 3.9301];
    const p2 = [43.7535, 3.8865, 43.7744, 3.9069];

    mapboxgl.accessToken = 'pk.eyJ1IjoiZG9lbGlhIiwiYSI6ImNqN3JydGhiZDN6cHEzM251dXVsZ3FodjQifQ.mtRIEu7WPakLBYQRVgV52g';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/outdoors-v11',
        center: [3.9060693, 43.766189],
        zoom: 14,
    });

    map.on('load', () => {
        map.addSource('source_suque', {
            type: 'image',
            url: 'https://stephane-tests.s3.eu-west-3.amazonaws.com/maps/suque_icons.png',
            coordinates: [
                [p1[1], p1[2]],
                [p1[3], p1[2]],
                [p1[3], p1[0]],
                [p1[1], p1[0]]
            ]
        });
        map.addLayer({
            "id": "overlay_suque",
            "source": "source_suque",
            "type": "raster",
        })
        
        map.addSource('source_ceceles', {
            type: 'image',
            url: 'https://stephane-tests.s3.eu-west-3.amazonaws.com/maps/ceceles_icons.png',
            coordinates: [
                [p2[1], p2[2]],
                [p2[3], p2[2]],
                [p2[3], p2[0]],
                [p2[1], p2[0]]
            ]
        });
        map.addLayer({
            "id": "overlay_ceceles",
            "source": "source_ceceles",
            "type": "raster",
        })

        map.addControl(
            new mapboxgl.GeolocateControl({
                positionOptions: {
                    enableHighAccuracy: true
                },
                trackUserLocation: true
            })
        );


        const images = [
            { id: 'eye', url: 'https://stephane-tests.s3.eu-west-3.amazonaws.com/maps/icons/eye.png' },
            { id: 'charboniere', url: 'https://stephane-tests.s3.eu-west-3.amazonaws.com/maps/icons/charboniere.png' },
            // { id: 'water', url: 'https://stephane-tests.s3.eu-west-3.amazonaws.com/maps/icons/water.png' },
            { id: 'sand', url: 'https://stephane-tests.s3.eu-west-3.amazonaws.com/maps/icons/sand.png' },
            { id: 'frog', url: 'https://stephane-tests.s3.eu-west-3.amazonaws.com/maps/icons/frog.png' },
            { id: 'sign', url: 'https://stephane-tests.s3.eu-west-3.amazonaws.com/maps/icons/sign.png' },
            { id: 'tree', url: 'https://stephane-tests.s3.eu-west-3.amazonaws.com/maps/icons/tree.png' },
        ];

        Promise.all(
            images.map(img => new Promise((resolve, reject) => {
                map.loadImage(img.url, function (error, res) {
                    map.addImage(img.id, res)
                    resolve();
                })
            }))
        )
            .then(() => {

                $(function() {
                    $.ajax({
                        dataType: "json",
                        url: "points.geojson",
                        success: function (geojson) {

                            geojson.features = geojson.features.filter(f => f.properties.picture);
                            geojson.features = geojson.features.map(f => ({
                                ...f,
                                geometry: {
                                    type: f.geometry.type,
                                    coordinates: [
                                        f.geometry.coordinates[0] + 0.0001,
                                        f.geometry.coordinates[1],
                                    ]
                                }
                            }))

                            map.addSource('points', {
                                'type': 'geojson',
                                'data': geojson
                            });

                            map.addLayer({
                                'id': 'points',
                                'source': 'points',
                                'type': 'circle',
                                'paint': {
                                    'circle-radius': {
                                        'base': 2,
                                        'stops': [[12, 2], [22, 180]]
                                    },
                                    // 'circle-pitch-scale': 'map',
                                    'circle-color': 'Yellow',
                                    'circle-stroke-width': {
                                        'base': 1.25,
                                        'stops': [[12, 2], [22, 180]]
                                    },
                                    'circle-stroke-opacity': 0,
                                },
                                // 'type': 'symbol',
                                // 'layout': {
                                //     "icon-pitch-alignment": "map",
                                //     'icon-image': ['get', 'icon'],
                                //     'icon-size': {
                                //          'base': .25,
                                //          'stops': [[12, 0.5], [22, 20]]
                                //     }
                                // }
                            });


                            map.on('click', 'points', function(e) {
                                var coordinates = e.features[0].geometry.coordinates.slice();
                                var picture_url = e.features[0].properties.picture;

                                new mapboxgl.Popup()
                                    .setLngLat(coordinates)
                                    .setHTML(`
                                        <div class="popup">
                                           <a href="${picture_url}" target="_blank">
                                           <img src="${picture_url}" class="picture">
                                            </a>
                                        </div>
                                    `)
                                    .addTo(map);
                            });

                        }
                    })
                })
            })

    })

</script>

</body>
</html>
